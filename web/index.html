<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>JARVIS KR</title>
  <meta name="theme-color" content="#111317">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{ --bg:#0b0e12; --panel:#11161d; --text:#e6eaf0; --muted:#97a1b0; --accent:#5aa8ff; --ok:#74d68a; --warn:#ffcd6b; }
    *{box-sizing:border-box} html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
    .app{max-width:720px; margin:0 auto; padding:18px; display:grid; gap:14px}
    header{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#18202b,#0f1217);display:grid;place-items:center;border:1px solid #1e2630}
    .title{font-weight:700; letter-spacing:.3px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button{background:var(--panel); color:var(--text); border:1px solid #1e2630; border-radius:12px; padding:10px 14px; cursor:pointer}
    button.primary{background:var(--accent); border-color:#2a6fb9; color:#fff}
    .panes{display:grid; gap:12px}
    .card{background:#0f141a; border:1px solid #1e2630; border-radius:14px; padding:12px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0}
    .muted{color:var(--muted); font-size:12px}
    textarea,input{width:100%; background:#0f141a; color:var(--text); border:1px solid #1e2630; border-radius:10px; padding:10px}
    #log{max-height:40vh; overflow:auto; font-size:14px; line-height:1.4}
    .logline{padding:6px 8px; border-bottom:1px dashed #1e2630}
    .you{color:#b7d2ff} .ai{color:#e6ffe6}
    .hint{color:var(--muted); font-size:12px}
    .pill{padding:4px 10px; border-radius:999px; border:1px solid #1e2630; background:#0b0f15; font-size:12px}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">ğŸ™</div>
      <div class="title">JARVIS KR</div>
      <span id="pwaStatus" class="pill">Android App (Capacitor)</span>
    </div>
    <div class="controls">
      <button id="btnMic" class="primary">ğŸ™ ë§í•˜ê¸° (Shift+Space)</button>
      <button id="btnSpeak">ğŸ”ˆ ìŒì„±</button>
      <button id="btnClear">ğŸ§¹ ë¡œê·¸ì§€ìš°ê¸°</button>
    </div>
  </header>

  <section class="panes">
    <div class="card">
      <div class="row"><b>ëª…ë ¹ ì˜ˆì‹œ</b></div>
      <div class="hint">
        â€œìë¹„ìŠ¤ íƒ€ì´ë¨¸ 3ë¶„â€, â€œìë¹„ìŠ¤ ì•ŒëŒ 07:30â€, â€œìë¹„ìŠ¤ ê³„ì‚° (2+3)*5â€, â€œìë¹„ìŠ¤ ë³€í™˜ 10 km to mâ€, â€œìë¹„ìŠ¤ ë©”ëª¨ ì¶”ê°€ ë‚´ì¼ íšŒì˜â€
      </div>
    </div>

    <div class="card">
      <div class="row"><b>í…ìŠ¤íŠ¸ë¡œ ëª…ë ¹</b></div>
      <div class="flex">
        <input id="textCmd" placeholder="ì˜ˆ: ìë¹„ìŠ¤ íƒ€ì´ë¨¸ 2ë¶„" />
        <button id="btnRun">ì‹¤í–‰</button>
      </div>
    </div>

    <div class="card">
      <div class="row"><b>ë¡œê·¸</b></div>
      <div id="log"></div>
    </div>
  </section>
</div>

<script>
// --- TTS toggle ---
let speakOn = false;
const btnSpeak = document.getElementById('btnSpeak');
btnSpeak.onclick = () => {
  speakOn = !speakOn;
  btnSpeak.textContent = speakOn ? 'ğŸ”‡ ìŒì„±ë„ê¸°' : 'ğŸ”ˆ ìŒì„±';
};
function say(text){
  if (!speakOn) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ko-KR';
  speechSynthesis.speak(u);
}

// --- Logger ---
const logEl = document.getElementById('log');
function log(role, text){
  const div = document.createElement('div');
  div.className = 'logline ' + (role==='you'?'you':'ai');
  div.textContent = (role==='you'?'[ë‚˜] ':'[ìë¹„ìŠ¤] ') + text;
  logEl.prepend(div);
}

// --- Commands ---
function runCommand(input){
  const s = input.trim();
  if (!s) return;
  log('you', s);
  try {
    let m = s.match(/íƒ€ì´ë¨¸\s*(\d+)\s*ë¶„?/);
    if (m){
      const mins = parseInt(m[1],10);
      setTimeout(()=>{ log('ai', `${mins}ë¶„ íƒ€ì´ë¨¸ ì¢…ë£Œ`); say(`${mins}ë¶„ íƒ€ì´ë¨¸ê°€ ëë‚¬ìŠµë‹ˆë‹¤`); }, mins*60000);
      log('ai', `íƒ€ì´ë¨¸ ì‹œì‘: ${mins}ë¶„`); say(`íƒ€ì´ë¨¸ë¥¼ ${mins}ë¶„ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤`); return;
    }
    m = s.match(/ì•ŒëŒ\s*(\d{1,2}):(\d{2})/);
    if (m){
      const hh = parseInt(m[1],10), mm = parseInt(m[2],10);
      const now = new Date(); const alarm = new Date();
      alarm.setHours(hh, mm, 0, 0);
      if (alarm <= now) alarm.setDate(alarm.getDate()+1);
      const dt = alarm - now;
      setTimeout(()=>{ log('ai', `ì•ŒëŒ: ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`); say('ì•ŒëŒ ì‹œê°„ì…ë‹ˆë‹¤'); }, dt);
      log('ai', `ì•ŒëŒ ì„¤ì •: ${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`);
      say('ì•ŒëŒì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤'); return;
    }
    m = s.match(/ê³„ì‚°\s*(.+)$/);
    if (m){
      const expr = m[1];
      if (!/^[-+/*().\d\s]+$/.test(expr)) throw new Error('ì‹ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ ìˆìŠµë‹ˆë‹¤');
      const result = Function(`"use strict"; return (${expr})`)();
      log('ai', `ê²°ê³¼: ${result}`); say(`ê²°ê³¼ëŠ” ${result}`); return;
    }
    m = s.match(/ë³€í™˜\s*(\d+(?:\.\d+)?)\s*(km|m|cm|mm)\s*(?:to|->|ì—ì„œ\s*|)\s*(km|m|cm|mm)/i);
    if (m){
      const v = parseFloat(m[1]); const scale={km:1000,m:1,cm:0.01,mm:0.001};
      const out = v * (scale[m[2]]/scale[m[3]]);
      log('ai', `${v} ${m[2]} = ${out} ${m[3]}`); say(`${v} ${m[2]} ëŠ” ${out} ${m[3]}`); return;
    }
    if (/ë©”ëª¨\s*ì¶”ê°€\s+(.+)/.test(s)){
      const item = s.replace(/.*ë©”ëª¨\s*ì¶”ê°€\s+/, '');
      const list = JSON.parse(localStorage.getItem('jarvis_memos')||'[]');
      list.push({t:Date.now(), text:item}); localStorage.setItem('jarvis_memos', JSON.stringify(list));
      log('ai', `ë©”ëª¨ ì¶”ê°€: ${item}`); say('ì¶”ê°€í–ˆìŠµë‹ˆë‹¤'); return;
    }
    if (/ë©”ëª¨\s*(ëª©ë¡|ë¦¬ìŠ¤íŠ¸)/.test(s)){
      const list = JSON.parse(localStorage.getItem('jarvis_memos')||'[]');
      if (list.length===0){ log('ai','ë©”ëª¨ ì—†ìŒ'); return; }
      list.slice(-5).reverse().forEach(x=>log('ai','- '+x.text)); return;
    }
    if (/ë©”ëª¨\s*(ëª¨ë‘\s*)?ì‚­ì œ/.test(s)){
      localStorage.removeItem('jarvis_memos'); log('ai','ë©”ëª¨ ì „ì²´ ì‚­ì œ'); return;
    }
    if (/ì‹œê°„|ëª‡ì‹œ/.test(s)){
      const now = new Date(); const hh = now.getHours(), mm = String(now.getMinutes()).padStart(2,'0');
      log('ai', `ì§€ê¸ˆ ì‹œê°„ì€ ${hh}ì‹œ ${mm}ë¶„`); say(`ì§€ê¸ˆì€ ${hh}ì‹œ ${mm}ë¶„ì…ë‹ˆë‹¤`); return;
    }
    if (/ë‚ ì§œ|ë©°ì¹ /.test(s)){
      const now = new Date(); const txt = now.toLocaleDateString('ko-KR', {year:'numeric', month:'long', day:'numeric', weekday:'long'});
      log('ai', `ì˜¤ëŠ˜ì€ ${txt}`); say(`ì˜¤ëŠ˜ì€ ${txt}`); return;
    }
    log('ai','ëª…ë ¹ì„ ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì˜ˆ: "ìë¹„ìŠ¤ íƒ€ì´ë¨¸ 3ë¶„"');
  } catch(err){ log('ai','ì˜¤ë¥˜: '+err.message); }
}

// --- Speech Recognition (if available in WebView/Chrome engine) ---
let rec = null, listening = false;
const btnMic = document.getElementById('btnMic');
function toggleRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){ log('ai','ì´ í™˜ê²½ì€ STTë¥¼ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (WebView ë²„ì „ì— ë”°ë¼ ë‹¤ë¦„)'); return; }
  if (listening){ rec && rec.stop(); return; }
  rec = new SR(); rec.lang='ko-KR'; rec.interimResults=false; rec.continuous=false;
  rec.onstart=()=>{ listening=true; btnMic.textContent='ğŸ›‘ ê·¸ë§Œ'; };
  rec.onend=()=>{ listening=false; btnMic.textContent='ğŸ™ ë§í•˜ê¸° (Shift+Space)'; };
  rec.onerror=e=>log('ai','STT ì˜¤ë¥˜: '+e.error);
  rec.onresult=e=>{ const text=e.results[0][0].transcript; log('you', text); runCommand(text); };
  rec.start();
}
btnMic.onclick = toggleRec;
document.addEventListener('keydown', (e)=>{ if (e.shiftKey && e.code==='Space'){ e.preventDefault(); toggleRec(); } });
document.getElementById('btnRun').onclick = () => { const v = document.getElementById('textCmd').value; if (v) runCommand(v); };
document.getElementById('btnClear').onclick = () => { document.getElementById('log').innerHTML=''; };
</script>
</body>
</html>
